684975b52c3de354ab37131fe15b10c6
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const globals_1 = require("@jest/globals");
const McpService_1 = require("../../../src/services/McpService");
describe('McpService', () => {
    let service;
    beforeEach(() => {
        // Create a new instance for each test
        service = new McpService_1.McpService();
        globals_1.jest.clearAllMocks();
    });
    afterEach(() => {
        service.destroy();
    });
    describe('initialization', () => {
        test('initializes successfully', async () => {
            await expect(service.initialize()).resolves.not.toThrow();
        });
        test('discovers MCP servers on initialization', async () => {
            await service.initialize();
            const servers = service.getServers();
            expect(servers).toHaveLength(2); // Claude Flow and RUV Swarm
            const claudeFlow = servers.find(s => s.id === 'claude-flow');
            expect(claudeFlow).toBeDefined();
            expect(claudeFlow.name).toBe('Claude Flow');
            expect(claudeFlow.status).toBe('connected');
            expect(claudeFlow.tools.length).toBeGreaterThan(0);
        });
        test('starts health monitoring on initialization', async () => {
            await service.initialize();
            const initialHealthScore = service.getServer('claude-flow')?.healthScore;
            // Wait for health check interval
            await new Promise(resolve => setTimeout(resolve, 35000));
            const updatedHealthScore = service.getServer('claude-flow')?.healthScore;
            // Health score should be updated (may be same value but lastPing should be different)
            expect(service.getServer('claude-flow')?.lastPing).toBeGreaterThan(Date.now() - 35000);
        });
    });
    describe('server management', () => {
        beforeEach(async () => {
            await service.initialize();
        });
        test('returns all servers', () => {
            const servers = service.getServers();
            expect(servers).toHaveLength(2);
            expect(servers.map(s => s.id)).toContain('claude-flow');
            expect(servers.map(s => s.id)).toContain('ruv-swarm');
        });
        test('returns specific server by id', () => {
            const server = service.getServer('claude-flow');
            expect(server).toBeDefined();
            expect(server.id).toBe('claude-flow');
            expect(server.name).toBe('Claude Flow');
        });
        test('returns undefined for non-existent server', () => {
            const server = service.getServer('non-existent');
            expect(server).toBeUndefined();
        });
        test('refreshes servers', async () => {
            const initialServers = service.getServers();
            const refreshedServers = await service.refreshServers();
            expect(refreshedServers).toHaveLength(initialServers.length);
            expect(refreshedServers.map(s => s.id)).toEqual(initialServers.map(s => s.id));
        });
    });
    describe('tool execution', () => {
        beforeEach(async () => {
            await service.initialize();
        });
        test('executes tool successfully', async () => {
            const result = await service.executeTool('claude-flow', 'mcp__claude-flow__swarm_init', { topology: 'mesh', maxAgents: 5 });
            expect(result.success).toBe(true);
            expect(result.toolName).toBe('mcp__claude-flow__swarm_init');
            expect(result.parameters).toEqual({ topology: 'mesh', maxAgents: 5 });
            expect(result.response).toBeDefined();
            expect(result.duration).toBeGreaterThan(0);
        });
        test('handles tool execution errors', async () => {
            const result = await service.executeTool('non-existent-server', 'some-tool', {});
            expect(result.success).toBe(false);
            expect(result.error).toBeDefined();
            expect(result.error).toContain('Server non-existent-server not found');
        });
        test('handles non-existent tool errors', async () => {
            const result = await service.executeTool('claude-flow', 'non-existent-tool', {});
            expect(result.success).toBe(false);
            expect(result.error).toBeDefined();
            expect(result.error).toContain('Tool non-existent-tool not found');
        });
        test('updates tool usage statistics', async () => {
            const initialServer = service.getServer('claude-flow');
            const initialTool = initialServer.tools.find(t => t.name === 'mcp__claude-flow__swarm_init');
            const initialUsageCount = initialTool.usageCount;
            await service.executeTool('claude-flow', 'mcp__claude-flow__swarm_init', { topology: 'mesh' });
            const updatedServer = service.getServer('claude-flow');
            const updatedTool = updatedServer.tools.find(t => t.name === 'mcp__claude-flow__swarm_init');
            expect(updatedTool.usageCount).toBe(initialUsageCount + 1);
            expect(updatedTool.lastUsed).toBeDefined();
        });
        test('updates metrics after tool execution', async () => {
            const initialMetrics = service.getMetrics();
            await service.executeTool('claude-flow', 'mcp__claude-flow__swarm_init', { topology: 'mesh' });
            const updatedMetrics = service.getMetrics();
            expect(updatedMetrics.totalRequests).toBe(initialMetrics.totalRequests + 1);
            expect(updatedMetrics.successfulRequests).toBe(initialMetrics.successfulRequests + 1);
        });
    });
    describe('metrics collection', () => {
        beforeEach(async () => {
            await service.initialize();
        });
        test('returns metrics object', () => {
            const metrics = service.getMetrics();
            expect(metrics).toBeDefined();
            expect(metrics.totalRequests).toBeDefined();
            expect(metrics.successfulRequests).toBeDefined();
            expect(metrics.failedRequests).toBeDefined();
            expect(metrics.averageResponseTime).toBeDefined();
            expect(metrics.uptime).toBeDefined();
            expect(metrics.memoryUsage).toBeDefined();
            expect(metrics.tokenUsage).toBeDefined();
            expect(metrics.serverMetrics).toBeDefined();
        });
        test('updates metrics over time', async () => {
            const initialMetrics = service.getMetrics();
            // Wait for metrics update interval
            await new Promise(resolve => setTimeout(resolve, 6000));
            const updatedMetrics = service.getMetrics();
            expect(updatedMetrics.uptime).toBeGreaterThan(initialMetrics.uptime);
        });
    });
    describe('health monitoring', () => {
        beforeEach(async () => {
            await service.initialize();
        });
        test('performs health checks periodically', async () => {
            const initialServer = service.getServer('claude-flow');
            const initialPing = initialServer.lastPing;
            // Wait for health check interval
            await new Promise(resolve => setTimeout(resolve, 35000));
            const updatedServer = service.getServer('claude-flow');
            expect(updatedServer.lastPing).toBeGreaterThan(initialPing);
        });
        test('maintains server health scores', async () => {
            const server = service.getServer('claude-flow');
            expect(server.healthScore).toBeGreaterThan(0);
            expect(server.healthScore).toBeLessThanOrEqual(100);
        });
    });
    describe('server types', () => {
        beforeEach(async () => {
            await service.initialize();
        });
        test('handles stdio server type', async () => {
            const claudeFlow = service.getServer('claude-flow');
            expect(claudeFlow.type).toBe('stdio');
            const result = await service.executeTool('claude-flow', 'mcp__claude-flow__swarm_init', { topology: 'mesh' });
            expect(result.success).toBe(true);
        });
        test('handles websocket server type', async () => {
            // GitHub integration server should be websocket type
            const servers = service.getServers();
            const githubServer = servers.find(s => s.type === 'websocket');
            if (githubServer) {
                expect(githubServer.type).toBe('websocket');
                const result = await service.executeTool(githubServer.id, githubServer.tools[0].name, {});
                expect(result).toBeDefined();
            }
        });
    });
    describe('error handling', () => {
        test('handles initialization errors gracefully', async () => {
            const consoleSpy = globals_1.jest.spyOn(console, 'error').mockImplementation(() => { });
            // Mock a method to throw an error
            const mockService = new McpService_1.McpService();
            mockService.discoverServers = globals_1.jest.fn().mockRejectedValue(new Error('Discovery failed'));
            await expect(mockService.initialize()).rejects.toThrow('Discovery failed');
            consoleSpy.mockRestore();
        });
        test('handles server detection errors gracefully', async () => {
            const consoleSpy = globals_1.jest.spyOn(console, 'warn').mockImplementation(() => { });
            await service.initialize();
            // Service should still initialize even if some servers fail to detect
            const servers = service.getServers();
            expect(servers).toBeDefined();
            consoleSpy.mockRestore();
        });
    });
    describe('cleanup', () => {
        test('destroys service properly', async () => {
            await service.initialize();
            const servers = service.getServers();
            expect(servers.length).toBeGreaterThan(0);
            service.destroy();
            const serversAfterDestroy = service.getServers();
            expect(serversAfterDestroy).toHaveLength(0);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL3dvcmtzcGFjZXMvYWdlbnRpc3RzLXF1aWNrc3RhcnQtd29ya3NwYWNlLWJhc2ljL3Nhc2kvdGVzdHMvdW5pdC9zZXJ2aWNlcy9NY3BTZXJ2aWNlLnRlc3QudHMiLCJtYXBwaW5ncyI6Ijs7QUFBQSwyQ0FBb0M7QUFDcEMsaUVBQXlFO0FBRXpFLFFBQVEsQ0FBQyxZQUFZLEVBQUUsR0FBRyxFQUFFO0lBQzFCLElBQUksT0FBbUIsQ0FBQTtJQUV2QixVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2Qsc0NBQXNDO1FBQ3RDLE9BQU8sR0FBRyxJQUFLLHVCQUFrQixFQUFFLENBQUE7UUFDbkMsY0FBSSxDQUFDLGFBQWEsRUFBRSxDQUFBO0lBQ3RCLENBQUMsQ0FBQyxDQUFBO0lBRUYsU0FBUyxDQUFDLEdBQUcsRUFBRTtRQUNiLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQTtJQUNuQixDQUFDLENBQUMsQ0FBQTtJQUVGLFFBQVEsQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLEVBQUU7UUFDOUIsSUFBSSxDQUFDLDBCQUEwQixFQUFFLEtBQUssSUFBSSxFQUFFO1lBQzFDLE1BQU0sTUFBTSxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLENBQUE7UUFDM0QsQ0FBQyxDQUFDLENBQUE7UUFFRixJQUFJLENBQUMseUNBQXlDLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDekQsTUFBTSxPQUFPLENBQUMsVUFBVSxFQUFFLENBQUE7WUFFMUIsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLFVBQVUsRUFBRSxDQUFBO1lBQ3BDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUEsQ0FBQyw0QkFBNEI7WUFFNUQsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssYUFBYSxDQUFDLENBQUE7WUFDNUQsTUFBTSxDQUFDLFVBQVUs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RSxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsVUFBVSxFQUFFLENBQUE7WUFDcEMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFBO1lBRTdCLFVBQVUsQ0FBQyxXQUFXLEVBQUUsQ0FBQTtRQUMxQixDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUMsQ0FBQyxDQUFBO0lBRUYsUUFBUSxDQUFDLFNBQVMsRUFBRSxHQUFHLEVBQUU7UUFDdkIsSUFBSSxDQUFDLDJCQUEyQixFQUFFLEtBQUssSUFBSSxFQUFFO1lBQzNDLE1BQU0sT0FBTyxDQUFDLFVBQVUsRUFBRSxDQUFBO1lBRTFCLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxVQUFVLEVBQUUsQ0FBQTtZQUNwQyxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQTtZQUV6QyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUE7WUFFakIsTUFBTSxtQkFBbUIsR0FBRyxPQUFPLENBQUMsVUFBVSxFQUFFLENBQUE7WUFDaEQsTUFBTSxDQUFDLG1CQUFtQixDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQzdDLENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDLENBQUMsQ0FBQSIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvd29ya3NwYWNlcy9hZ2VudGlzdHMtcXVpY2tzdGFydC13b3Jrc3BhY2UtYmFzaWMvc2FzaS90ZXN0cy91bml0L3NlcnZpY2VzL01jcFNlcnZpY2UudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBqZXN0IH0gZnJvbSAnQGplc3QvZ2xvYmFscydcbmltcG9ydCB7IG1jcFNlcnZpY2UsIE1jcFNlcnZpY2UgfSBmcm9tICcuLi8uLi8uLi9zcmMvc2VydmljZXMvTWNwU2VydmljZSdcblxuZGVzY3JpYmUoJ01jcFNlcnZpY2UnLCAoKSA9PiB7XG4gIGxldCBzZXJ2aWNlOiBNY3BTZXJ2aWNlXG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgLy8gQ3JlYXRlIGEgbmV3IGluc3RhbmNlIGZvciBlYWNoIHRlc3RcbiAgICBzZXJ2aWNlID0gbmV3IChNY3BTZXJ2aWNlIGFzIGFueSkoKVxuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpXG4gIH0pXG5cbiAgYWZ0ZXJFYWNoKCgpID0+IHtcbiAgICBzZXJ2aWNlLmRlc3Ryb3koKVxuICB9KVxuXG4gIGRlc2NyaWJlKCdpbml0aWFsaXphdGlvbicsICgpID0+IHtcbiAgICB0ZXN0KCdpbml0aWFsaXplcyBzdWNjZXNzZnVsbHknLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBleHBlY3Qoc2VydmljZS5pbml0aWFsaXplKCkpLnJlc29sdmVzLm5vdC50b1Rocm93KClcbiAgICB9KVxuXG4gICAgdGVzdCgnZGlzY292ZXJzIE1DUCBzZXJ2ZXJzIG9uIGluaXRpYWxpemF0aW9uJywgYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgc2VydmljZS5pbml0aWFsaXplKClcbiAgICAgIFxuICAgICAgY29uc3Qgc2VydmVycyA9IHNlcnZpY2UuZ2V0U2VydmVycygpXG4gICAgICBleHBlY3Qoc2VydmVycykudG9IYXZlTGVuZ3RoKDIpIC8vIENsYXVkZSBGbG93IGFuZCBSVVYgU3dhcm1cbiAgICAgIFxuICAgICAgY29uc3QgY2xhdWRlRmxvdyA9IHNlcnZlcnMuZmluZChzID0+IHMuaWQgPT09ICdjbGF1ZGUtZmxvdycpXG4gICAgICBleHBlY3QoY2xhdWRlRmxvdykudG9CZURlZmluZWQoKVxuICAgICAgZXhwZWN0KGNsYXVkZUZsb3chLm5hbWUpLnRvQmUoJ0NsYXVkZSBGbG93JylcbiAgICAgIGV4cGVjdChjbGF1ZGVGbG93IS5zdGF0dXMpLnRvQmUoJ2Nvbm5lY3RlZCcpXG4gICAgICBleHBlY3QoY2xhdWRlRmxvdyEudG9vbHMubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oMClcbiAgICB9KVxuXG4gICAgdGVzdCgnc3RhcnRzIGhlYWx0aCBtb25pdG9yaW5nIG9uIGluaXRpYWxpemF0aW9uJywgYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgc2VydmljZS5pbml0aWFsaXplKClcbiAgICAgIFxuICAgICAgY29uc3QgaW5pdGlhbEhlYWx0aFNjb3JlID0gc2VydmljZS5nZXRTZXJ2ZXIoJ2NsYXVkZS1mbG93Jyk/LmhlYWx0aFNjb3JlXG4gICAgICBcbiAgICAgIC8vIFdhaXQgZm9yIGhlYWx0aCBjaGVjayBpbnRlcnZhbFxuICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDM1MDAwKSlcbiAgICAgIFxuICAgICAgY29uc3QgdXBkYXRlZEhlYWx0aFNjb3JlID0gc2VydmljZS5nZXRTZXJ2ZXIoJ2NsYXVkZS1mbG93Jyk/LmhlYWx0aFNjb3JlXG4gICAgICBcbiAgICAgIC8vIEhlYWx0aCBzY29yZSBzaG91bGQgYmUgdXBkYXRlZCAobWF5IGJlIHNhbWUgdmFsdWUgYnV0IGxhc3RQaW5nIHNob3VsZCBiZSBkaWZmZXJlbnQpXG4gICAgICBleHBlY3Qoc2VydmljZS5nZXRTZXJ2ZXIoJ2NsYXVkZS1mbG93Jyk/Lmxhc3RQaW5nKS50b0JlR3JlYXRlclRoYW4oRGF0ZS5ub3coKSAtIDM1MDAwKVxuICAgIH0pXG4gIH0pXG5cbiAgZGVzY3JpYmUoJ3NlcnZlciBtYW5hZ2VtZW50JywgKCkgPT4ge1xuICAgIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgc2VydmljZS5pbml0aWFsaXplKClcbiAgICB9KVxuXG4gICAgdGVzdCgncmV0dXJucyBhbGwgc2VydmVycycsICgpID0+IHtcbiAgICAgIGNvbnN0IHNlcnZlcnMgPSBzZXJ2aWNlLmdldFNlcnZlcnMoKVxuICAgICAgZXhwZWN0KHNlcnZlcnMpLnRvSGF2ZUxlbmd0aCgyKVxuICAgICAgZXhwZWN0KHNlcnZlcnMubWFwKHMgPT4gcy5pZCkpLnRvQ29udGFpbignY2xhdWRlLWZsb3cnKVxuICAgICAgZXhwZWN0KHNlcnZlcnMubWFwKHMgPT4gcy5pZCkpLnRvQ29udGFpbigncnV2LXN3YXJtJylcbiAgICB9KVxuXG4gICAgdGVzdCgncmV0dXJucyBzcGVjaWZpYyBzZXJ2ZXIgYnkgaWQnLCAoKSA9PiB7XG4gICAgICBjb25zdCBzZXJ2ZXIgPSBzZXJ2aWNlLmdldFNlcnZlcignY2xhdWRlLWZsb3cnKVxuICAgICAgZXhwZWN0KHNlcnZlcikudG9CZURlZmluZWQoKVxuICAgICAgZXhwZWN0KHNlcnZlciEuaWQpLnRvQmUoJ2NsYXVkZS1mbG93JylcbiAgICAgIGV4cGVjdChzZXJ2ZXIhLm5hbWUpLnRvQmUoJ0NsYXVkZSBGbG93JylcbiAgICB9KVxuXG4gICAgdGVzdCgncmV0dXJucyB1bmRlZmluZWQgZm9yIG5vbi1leGlzdGVudCBzZXJ2ZXInLCAoKSA9PiB7XG4gICAgICBjb25zdCBzZXJ2ZXIgPSBzZXJ2aWNlLmdldFNlcnZlcignbm9uLWV4aXN0ZW50JylcbiAgICAgIGV4cGVjdChzZXJ2ZXIpLnRvQmVVbmRlZmluZWQoKVxuICAgIH0pXG5cbiAgICB0ZXN0KCdyZWZyZXNoZXMgc2VydmVycycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGluaXRpYWxTZXJ2ZXJzID0gc2VydmljZS5nZXRTZXJ2ZXJzKClcbiAgICAgIGNvbnN0IHJlZnJlc2hlZFNlcnZlcnMgPSBhd2FpdCBzZXJ2aWNlLnJlZnJlc2hTZXJ2ZXJzKClcbiAgICAgIFxuICAgICAgZXhwZWN0KHJlZnJlc2hlZFNlcnZlcnMpLnRvSGF2ZUxlbmd0aChpbml0aWFsU2VydmVycy5sZW5ndGgpXG4gICAgICBleHBlY3QocmVmcmVzaGVkU2VydmVycy5tYXAocyA9PiBzLmlkKSkudG9FcXVhbChpbml0aWFsU2VydmVycy5tYXAocyA9PiBzLmlkKSlcbiAgICB9KVxuICB9KVxuXG4gIGRlc2NyaWJlKCd0b29sIGV4ZWN1dGlvbicsICgpID0+IHtcbiAgICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHNlcnZpY2UuaW5pdGlhbGl6ZSgpXG4gICAgfSlcblxuICAgIHRlc3QoJ2V4ZWN1dGVzIHRvb2wgc3VjY2Vzc2Z1bGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS5leGVjdXRlVG9vbChcbiAgICAgICAgJ2NsYXVkZS1mbG93JyxcbiAgICAgICAgJ21jcF9fY2xhdWRlLWZsb3dfX3N3YXJtX2luaXQnLFxuICAgICAgICB7IHRvcG9sb2d5OiAnbWVzaCcsIG1heEFnZW50czogNSB9XG4gICAgICApXG4gICAgICBcbiAgICAgIGV4cGVjdChyZXN1bHQuc3VjY2VzcykudG9CZSh0cnVlKVxuICAgICAgZXhwZWN0KHJlc3VsdC50b29sTmFtZSkudG9CZSgnbWNwX19jbGF1ZGUtZmxvd19fc3dhcm1faW5pdCcpXG4gICAgICBleHBlY3QocmVzdWx0LnBhcmFtZXRlcnMpLnRvRXF1YWwoeyB0b3BvbG9neTogJ21lc2gnLCBtYXhBZ2VudHM6IDUgfSlcbiAgICAgIGV4cGVjdChyZXN1bHQucmVzcG9uc2UpLnRvQmVEZWZpbmVkKClcbiAgICAgIGV4cGVjdChyZXN1bHQuZHVyYXRpb24pLnRvQmVHcmVhdGVyVGhhbigwKVxuICAgIH0pXG5cbiAgICB0ZXN0KCdoYW5kbGVzIHRvb2wgZXhlY3V0aW9uIGVycm9ycycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UuZXhlY3V0ZVRvb2woXG4gICAgICAgICdub24tZXhpc3RlbnQtc2VydmVyJyxcbiAgICAgICAgJ3NvbWUtdG9vbCcsXG4gICAgICAgIHt9XG4gICAgICApXG4gICAgICBcbiAgICAgIGV4cGVjdChyZXN1bHQuc3VjY2VzcykudG9CZShmYWxzZSlcbiAgICAgIGV4cGVjdChyZXN1bHQuZXJyb3IpLnRvQmVEZWZpbmVkKClcbiAgICAgIGV4cGVjdChyZXN1bHQuZXJyb3IpLnRvQ29udGFpbignU2VydmVyIG5vbi1leGlzdGVudC1zZXJ2ZXIgbm90IGZvdW5kJylcbiAgICB9KVxuXG4gICAgdGVzdCgnaGFuZGxlcyBub24tZXhpc3RlbnQgdG9vbCBlcnJvcnMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLmV4ZWN1dGVUb29sKFxuICAgICAgICAnY2xhdWRlLWZsb3cnLFxuICAgICAgICAnbm9uLWV4aXN0ZW50LXRvb2wnLFxuICAgICAgICB7fVxuICAgICAgKVxuICAgICAgXG4gICAgICBleHBlY3QocmVzdWx0LnN1Y2Nlc3MpLnRvQmUoZmFsc2UpXG4gICAgICBleHBlY3QocmVzdWx0LmVycm9yKS50b0JlRGVmaW5lZCgpXG4gICAgICBleHBlY3QocmVzdWx0LmVycm9yKS50b0NvbnRhaW4oJ1Rvb2wgbm9uLWV4aXN0ZW50LXRvb2wgbm90IGZvdW5kJylcbiAgICB9KVxuXG4gICAgdGVzdCgndXBkYXRlcyB0b29sIHVzYWdlIHN0YXRpc3RpY3MnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBpbml0aWFsU2VydmVyID0gc2VydmljZS5nZXRTZXJ2ZXIoJ2NsYXVkZS1mbG93JykhXG4gICAgICBjb25zdCBpbml0aWFsVG9vbCA9IGluaXRpYWxTZXJ2ZXIudG9vbHMuZmluZCh0ID0+IHQubmFtZSA9PT0gJ21jcF9fY2xhdWRlLWZsb3dfX3N3YXJtX2luaXQnKSFcbiAgICAgIGNvbnN0IGluaXRpYWxVc2FnZUNvdW50ID0gaW5pdGlhbFRvb2wudXNhZ2VDb3VudFxuICAgICAgXG4gICAgICBhd2FpdCBzZXJ2aWNlLmV4ZWN1dGVUb29sKFxuICAgICAgICAnY2xhdWRlLWZsb3cnLFxuICAgICAgICAnbWNwX19jbGF1ZGUtZmxvd19fc3dhcm1faW5pdCcsXG4gICAgICAgIHsgdG9wb2xvZ3k6ICdtZXNoJyB9XG4gICAgICApXG4gICAgICBcbiAgICAgIGNvbnN0IHVwZGF0ZWRTZXJ2ZXIgPSBzZXJ2aWNlLmdldFNlcnZlcignY2xhdWRlLWZsb3cnKSFcbiAgICAgIGNvbnN0IHVwZGF0ZWRUb29sID0gdXBkYXRlZFNlcnZlci50b29scy5maW5kKHQgPT4gdC5uYW1lID09PSAnbWNwX19jbGF1ZGUtZmxvd19fc3dhcm1faW5pdCcpIVxuICAgICAgXG4gICAgICBleHBlY3QodXBkYXRlZFRvb2wudXNhZ2VDb3VudCkudG9CZShpbml0aWFsVXNhZ2VDb3VudCArIDEpXG4gICAgICBleHBlY3QodXBkYXRlZFRvb2wubGFzdFVzZWQpLnRvQmVEZWZpbmVkKClcbiAgICB9KVxuXG4gICAgdGVzdCgndXBkYXRlcyBtZXRyaWNzIGFmdGVyIHRvb2wgZXhlY3V0aW9uJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgaW5pdGlhbE1ldHJpY3MgPSBzZXJ2aWNlLmdldE1ldHJpY3MoKVxuICAgICAgXG4gICAgICBhd2FpdCBzZXJ2aWNlLmV4ZWN1dGVUb29sKFxuICAgICAgICAnY2xhdWRlLWZsb3cnLFxuICAgICAgICAnbWNwX19jbGF1ZGUtZmxvd19fc3dhcm1faW5pdCcsXG4gICAgICAgIHsgdG9wb2xvZ3k6ICdtZXNoJyB9XG4gICAgICApXG4gICAgICBcbiAgICAgIGNvbnN0IHVwZGF0ZWRNZXRyaWNzID0gc2VydmljZS5nZXRNZXRyaWNzKClcbiAgICAgIFxuICAgICAgZXhwZWN0KHVwZGF0ZWRNZXRyaWNzLnRvdGFsUmVxdWVzdHMpLnRvQmUoaW5pdGlhbE1ldHJpY3MudG90YWxSZXF1ZXN0cyArIDEpXG4gICAgICBleHBlY3QodXBkYXRlZE1ldHJpY3Muc3VjY2Vzc2Z1bFJlcXVlc3RzKS50b0JlKGluaXRpYWxNZXRyaWNzLnN1Y2Nlc3NmdWxSZXF1ZXN0cyArIDEpXG4gICAgfSlcbiAgfSlcblxuICBkZXNjcmliZSgnbWV0cmljcyBjb2xsZWN0aW9uJywgKCkgPT4ge1xuICAgIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgc2VydmljZS5pbml0aWFsaXplKClcbiAgICB9KVxuXG4gICAgdGVzdCgncmV0dXJucyBtZXRyaWNzIG9iamVjdCcsICgpID0+IHtcbiAgICAgIGNvbnN0IG1ldHJpY3MgPSBzZXJ2aWNlLmdldE1ldHJpY3MoKVxuICAgICAgXG4gICAgICBleHBlY3QobWV0cmljcykudG9CZURlZmluZWQoKVxuICAgICAgZXhwZWN0KG1ldHJpY3MudG90YWxSZXF1ZXN0cykudG9CZURlZmluZWQoKVxuICAgICAgZXhwZWN0KG1ldHJpY3Muc3VjY2Vzc2Z1bFJlcXVlc3RzKS50b0JlRGVmaW5lZCgpXG4gICAgICBleHBlY3QobWV0cmljcy5mYWlsZWRSZXF1ZXN0cykudG9CZURlZmluZWQoKVxuICAgICAgZXhwZWN0KG1ldHJpY3MuYXZlcmFnZVJlc3BvbnNlVGltZSkudG9CZURlZmluZWQoKVxuICAgICAgZXhwZWN0KG1ldHJpY3MudXB0aW1lKS50b0JlRGVmaW5lZCgpXG4gICAgICBleHBlY3QobWV0cmljcy5tZW1vcnlVc2FnZSkudG9CZURlZmluZWQoKVxuICAgICAgZXhwZWN0KG1ldHJpY3MudG9rZW5Vc2FnZSkudG9CZURlZmluZWQoKVxuICAgICAgZXhwZWN0KG1ldHJpY3Muc2VydmVyTWV0cmljcykudG9CZURlZmluZWQoKVxuICAgIH0pXG5cbiAgICB0ZXN0KCd1cGRhdGVzIG1ldHJpY3Mgb3ZlciB0aW1lJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgaW5pdGlhbE1ldHJpY3MgPSBzZXJ2aWNlLmdldE1ldHJpY3MoKVxuICAgICAgXG4gICAgICAvLyBXYWl0IGZvciBtZXRyaWNzIHVwZGF0ZSBpbnRlcnZhbFxuICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDYwMDApKVxuICAgICAgXG4gICAgICBjb25zdCB1cGRhdGVkTWV0cmljcyA9IHNlcnZpY2UuZ2V0TWV0cmljcygpXG4gICAgICBcbiAgICAgIGV4cGVjdCh1cGRhdGVkTWV0cmljcy51cHRpbWUpLnRvQmVHcmVhdGVyVGhhbihpbml0aWFsTWV0cmljcy51cHRpbWUpXG4gICAgfSlcbiAgfSlcblxuICBkZXNjcmliZSgnaGVhbHRoIG1vbml0b3JpbmcnLCAoKSA9PiB7XG4gICAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBzZXJ2aWNlLmluaXRpYWxpemUoKVxuICAgIH0pXG5cbiAgICB0ZXN0KCdwZXJmb3JtcyBoZWFsdGggY2hlY2tzIHBlcmlvZGljYWxseScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGluaXRpYWxTZXJ2ZXIgPSBzZXJ2aWNlLmdldFNlcnZlcignY2xhdWRlLWZsb3cnKSFcbiAgICAgIGNvbnN0IGluaXRpYWxQaW5nID0gaW5pdGlhbFNlcnZlci5sYXN0UGluZ1xuICAgICAgXG4gICAgICAvLyBXYWl0IGZvciBoZWFsdGggY2hlY2sgaW50ZXJ2YWxcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCAzNTAwMCkpXG4gICAgICBcbiAgICAgIGNvbnN0IHVwZGF0ZWRTZXJ2ZXIgPSBzZXJ2aWNlLmdldFNlcnZlcignY2xhdWRlLWZsb3cnKSFcbiAgICAgIGV4cGVjdCh1cGRhdGVkU2VydmVyLmxhc3RQaW5nKS50b0JlR3JlYXRlclRoYW4oaW5pdGlhbFBpbmcpXG4gICAgfSlcblxuICAgIHRlc3QoJ21haW50YWlucyBzZXJ2ZXIgaGVhbHRoIHNjb3JlcycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHNlcnZlciA9IHNlcnZpY2UuZ2V0U2VydmVyKCdjbGF1ZGUtZmxvdycpIVxuICAgICAgZXhwZWN0KHNlcnZlci5oZWFsdGhTY29yZSkudG9CZUdyZWF0ZXJUaGFuKDApXG4gICAgICBleHBlY3Qoc2VydmVyLmhlYWx0aFNjb3JlKS50b0JlTGVzc1RoYW5PckVxdWFsKDEwMClcbiAgICB9KVxuICB9KVxuXG4gIGRlc2NyaWJlKCdzZXJ2ZXIgdHlwZXMnLCAoKSA9PiB7XG4gICAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBzZXJ2aWNlLmluaXRpYWxpemUoKVxuICAgIH0pXG5cbiAgICB0ZXN0KCdoYW5kbGVzIHN0ZGlvIHNlcnZlciB0eXBlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgY2xhdWRlRmxvdyA9IHNlcnZpY2UuZ2V0U2VydmVyKCdjbGF1ZGUtZmxvdycpIVxuICAgICAgZXhwZWN0KGNsYXVkZUZsb3cudHlwZSkudG9CZSgnc3RkaW8nKVxuICAgICAgXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLmV4ZWN1dGVUb29sKFxuICAgICAgICAnY2xhdWRlLWZsb3cnLFxuICAgICAgICAnbWNwX19jbGF1ZGUtZmxvd19fc3dhcm1faW5pdCcsXG4gICAgICAgIHsgdG9wb2xvZ3k6ICdtZXNoJyB9XG4gICAgICApXG4gICAgICBcbiAgICAgIGV4cGVjdChyZXN1bHQuc3VjY2VzcykudG9CZSh0cnVlKVxuICAgIH0pXG5cbiAgICB0ZXN0KCdoYW5kbGVzIHdlYnNvY2tldCBzZXJ2ZXIgdHlwZScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEdpdEh1YiBpbnRlZ3JhdGlvbiBzZXJ2ZXIgc2hvdWxkIGJlIHdlYnNvY2tldCB0eXBlXG4gICAgICBjb25zdCBzZXJ2ZXJzID0gc2VydmljZS5nZXRTZXJ2ZXJzKClcbiAgICAgIGNvbnN0IGdpdGh1YlNlcnZlciA9IHNlcnZlcnMuZmluZChzID0+IHMudHlwZSA9PT0gJ3dlYnNvY2tldCcpXG4gICAgICBcbiAgICAgIGlmIChnaXRodWJTZXJ2ZXIpIHtcbiAgICAgICAgZXhwZWN0KGdpdGh1YlNlcnZlci50eXBlKS50b0JlKCd3ZWJzb2NrZXQnKVxuICAgICAgICBcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS5leGVjdXRlVG9vbChcbiAgICAgICAgICBnaXRodWJTZXJ2ZXIuaWQsXG4gICAgICAgICAgZ2l0aHViU2VydmVyLnRvb2xzWzBdLm5hbWUsXG4gICAgICAgICAge31cbiAgICAgICAgKVxuICAgICAgICBcbiAgICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZURlZmluZWQoKVxuICAgICAgfVxuICAgIH0pXG4gIH0pXG5cbiAgZGVzY3JpYmUoJ2Vycm9yIGhhbmRsaW5nJywgKCkgPT4ge1xuICAgIHRlc3QoJ2hhbmRsZXMgaW5pdGlhbGl6YXRpb24gZXJyb3JzIGdyYWNlZnVsbHknLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBjb25zb2xlU3B5ID0gamVzdC5zcHlPbihjb25zb2xlLCAnZXJyb3InKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4ge30pXG4gICAgICBcbiAgICAgIC8vIE1vY2sgYSBtZXRob2QgdG8gdGhyb3cgYW4gZXJyb3JcbiAgICAgIGNvbnN0IG1vY2tTZXJ2aWNlID0gbmV3IChNY3BTZXJ2aWNlIGFzIGFueSkoKVxuICAgICAgbW9ja1NlcnZpY2UuZGlzY292ZXJTZXJ2ZXJzID0gamVzdC5mbigpLm1vY2tSZWplY3RlZFZhbHVlKG5ldyBFcnJvcignRGlzY292ZXJ5IGZhaWxlZCcpKVxuICAgICAgXG4gICAgICBhd2FpdCBleHBlY3QobW9ja1NlcnZpY2UuaW5pdGlhbGl6ZSgpKS5yZWplY3RzLnRvVGhyb3coJ0Rpc2NvdmVyeSBmYWlsZWQnKVxuICAgICAgXG4gICAgICBjb25zb2xlU3B5Lm1vY2tSZXN0b3JlKClcbiAgICB9KVxuXG4gICAgdGVzdCgnaGFuZGxlcyBzZXJ2ZXIgZGV0ZWN0aW9uIGVycm9ycyBncmFjZWZ1bGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgY29uc29sZVNweSA9IGplc3Quc3B5T24oY29uc29sZSwgJ3dhcm4nKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4ge30pXG4gICAgICBcbiAgICAgIGF3YWl0IHNlcnZpY2UuaW5pdGlhbGl6ZSgpXG4gICAgICBcbiAgICAgIC8vIFNlcnZpY2Ugc2hvdWxkIHN0aWxsIGluaXRpYWxpemUgZXZlbiBpZiBzb21lIHNlcnZlcnMgZmFpbCB0byBkZXRlY3RcbiAgICAgIGNvbnN0IHNlcnZlcnMgPSBzZXJ2aWNlLmdldFNlcnZlcnMoKVxuICAgICAgZXhwZWN0KHNlcnZlcnMpLnRvQmVEZWZpbmVkKClcbiAgICAgIFxuICAgICAgY29uc29sZVNweS5tb2NrUmVzdG9yZSgpXG4gICAgfSlcbiAgfSlcblxuICBkZXNjcmliZSgnY2xlYW51cCcsICgpID0+IHtcbiAgICB0ZXN0KCdkZXN0cm95cyBzZXJ2aWNlIHByb3Blcmx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgc2VydmljZS5pbml0aWFsaXplKClcbiAgICAgIFxuICAgICAgY29uc3Qgc2VydmVycyA9IHNlcnZpY2UuZ2V0U2VydmVycygpXG4gICAgICBleHBlY3Qoc2VydmVycy5sZW5ndGgpLnRvQmVHcmVhdGVyVGhhbigwKVxuICAgICAgXG4gICAgICBzZXJ2aWNlLmRlc3Ryb3koKVxuICAgICAgXG4gICAgICBjb25zdCBzZXJ2ZXJzQWZ0ZXJEZXN0cm95ID0gc2VydmljZS5nZXRTZXJ2ZXJzKClcbiAgICAgIGV4cGVjdChzZXJ2ZXJzQWZ0ZXJEZXN0cm95KS50b0hhdmVMZW5ndGgoMClcbiAgICB9KVxuICB9KVxufSkiXSwidmVyc2lvbiI6M30=